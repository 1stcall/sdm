#!/bin/bash
#
# This file is sourced by some sdm-related scripts
#
[[ "${BASH_SOURCE[0]}" =~ "/mnt/sdm" ]] && i="/mnt/sdm" || i=""
sifs=$IFS; IFS=":"
while read rpifun value
do
    if [[ ! $rpifun =~ ^\ *# && -n $rpifun ]] # skip comment and malformed lines
        then
            value="${value%%\#*}"    # Del EOL comments
            value="${value%"${value##*[^[:blank:]]}"}"  # Del trailing spaces/tabs
            value="${value%\"}"     # Del opening double-quotes 
            value="${value#\"}"     # Del closing double-quotes 
            value="${value%\'}"     # Del opening single-quotes 
            value="${value#\'}"     # Del closing single-quotes 
	    eval "${rpifun}=\"$value\""
    fi
done < $i/etc/sdm/cparams
IFS=$sifs
#
# These functions are used by sdm-phase1 and sdm-customphase
#
function outlong () {
    #
    if [ ${#1} -le 96 ]
    then
	echo "$(date +'%Y-%m-%d %H:%M:%S') $1" >> $2
    else
	readarray -t str <<< $(fold -s -w96 <<< $(echo $1))
	spc=""
	for (( i=0 ; i < ${#str[@]} ; i++))
	do
	    echo "$(date +'%Y-%m-%d %H:%M:%S') ${spc}${str[$i]}" >> $2
	    spc="  "
	done
    fi
}

function doapt() {
    #
    # $1 is apt command
    # $2 is $showapt value
    #
    echo "" >> /etc/sdm/apt.log
    outlong "apt $1" "/etc/sdm/apt.log"
    echo "" >> /etc/sdm/apt.log
    if [ "$2" == "1" ]
    then
	apt -q $1 | tee -a /etc/sdm/apt.log
    else
	apt -q $1 >> /etc/sdm/apt.log
    fi
}
