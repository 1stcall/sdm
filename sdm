#!/bin/bash
#
#
# Manage, customize, or burn an SSD or SD Card from a RasPiOS image
#
# Useful for maintaining one or more Pis. The general idea is to keep a "golden" image
# fully configured to suit your needs. Then, whenever you need a new SSD or SD Card (testing, new Pi, etc),
# start with the golden master. Also, when new RasPiOS releases come out, sdm can be used
# to easily build a fresh image for the new release.
#
# This script provides the infrastructure for your customization scripts to work
# in a repeatable manner against an RPF-provided IMG file. 
#
# sdm [switches] image-name
# sdm --help will provide help on all available switches
#
# RPi Image management phases. See README.md for details
# Phase   Tasks
#     0   Copy files into unzipped IMG file (sdm calls phase0 script)
#         IMG file mounted so files can easily be copied into the IMG file
#     1   Nspawn into image to execute in the image context (via sdm)
#         APT packages can be installed in phase 1 so available on every SD card
#         Your custom script can be as automatic or manual as you choose
#         See sdm-customphase for an example
#     2   Write SSD or SD card from the IMG file (via sdm --burn)
#         Target system name is inserted onto the device after it's written
#     3   Boot the newly-created storage device
#

function errexit() {
    echo "$1"
    ismounted /mnt/sdm && docleanup
    exit 1
}

function exitiferr() {
    [ "${1:0:1}" == "?" ] && errexit "$1"
}

function docleanup() {
    umount -v /mnt/sdm/{boot,}
    [ "$loop" != "" ] && losetup -d $loop
    sync
}

function ismounted() {
    if grep -qs $1 /proc/mounts
    then
	return 0
    else
	return 1
    fi
}

function domount() {
    local p1="1" p2="2"
    [ ! -d /mnt/sdm ] && mkdir /mnt/sdm
    if [ $fdirtree -eq 1 ]
    then
	mount --bind $dimg      /mnt/sdm
	mount --bind $dimg/boot /mnt/sdm/boot
    elif [ $dimgdev -eq 0 ]
    then
	echo "Mounting IMG '$dimg'"
	loop=$(losetup --show -P -f $dimg)
	mount -v ${loop}p2 /mnt/sdm
	mount -v ${loop}p1 /mnt/sdm/boot
    else
	[[ "$dimg" =~ "mmcblk" ]] && p1="p1" && p2="p2"
	echo "Mounting device '$dimg'"
	mount -v ${dimg}${p2} /mnt/sdm
	mount -v ${dimg}${p1} /mnt/sdm/boot
	loop=""
    fi
}

function checknumeric() {
    #
    # Exit with error if $1 is not numeric
    #
    [[ "$1" = *[^0-9]* ]] && errexit "? Value '$1' for command switch '$2' is not numeric"
    return
}

function fndotfullpath() {
    #
    # Fix directory if it's "."
    #
    local fn="$1"
    if [ "$fn" != "" ]
    then
	[ "$(dirname $fn)" == "." ] && fn="$(pwd)/$fn"    # Ensure fully qualified path to cscript
    fi
    echo $fn
}

function extendimage() {
    local ldimg=$1 limgext=$2
    local line dsiz
    dd if=/dev/zero bs=1M count=$limgext status=progress >> $ldimg

    # Get the actual size of the image file from parted
    while read line ; do
	if [[ "$line" =~ "Disk" ]] 
	then
	    if [[ ! "$line" =~ "Flags:" ]]   # Only want the Disk size line, not one with "Disk Flags"
	    then
                                     # Disk img-file-name.img:    nnnnMB
		dsiz="${line##*:}"   # Get String following ":"
		dsiz="${dsiz##\ }"   # Strip leading spaces
		dsiz="${dsiz%%\ }"   # Strip trailing spaces
	    fi
	fi
    done < <(parted $ldimg <<EOF
print
EOF
) # This closes the above parted command
    echo "Resize partition 2 and file system"
    parted $ldimg <<EOF
resizepart 2 $dsiz
EOF
}

function poptcheck() {
    #
    # Check options settings against valid settings
    # Report errors and exit
    #
    local popt="$1" vopt="$2" switchname="$3" badopt="" nopt="" xopt=() o os badopt
    if [ "$popt" != "" ]
    then
	readarray -d, xopt <<< $popt
	for o in ${xopt[@]}
	do
	    os="${o%,}"
	    os="${os# }"
	    if ! [[ "$vopt" =~ "|$os|" ]]
	    then
		[ "$badopt" != "" ] && badopt="$badopt, '$os'" || badopt="'$os'"
	    else
		nopt="$nopt|$os"
	    fi
	done
	[ "$badopt" != "" ] && echo "? Unrecognized $switchname value(s) $badopt" || echo "$nopt|"
    else
	echo ""
    fi
}

function findappfile() {
    #
    # $1 = app/xapp variable
    # $2 = app/xapp output variable
    #
    # Updates app/xapp output variable with actual file location
    # or the value of $1 if it's not a file location (no leading '@')
    #
    local fn fnc
    if [ "${1:0:1}" == "@" ]
    then
	fn="${1:1:999}"
	fn="$(fndotfullpath $fn)"
	if [ ! -f "$fn" ]
	then
	    fnc="$src/$(basename $fn)"
	    if [ ! -f "$fnc" ]
	    then
		echo "? $2 file '$fn' not found"
		return
	    else
		echo "@$fnc"
	    fi
	else
	    echo "@$fn"
	fi
    else
	echo "$1"
    fi
}

function getapplist() {
    #
    # $1 has list of apps or @file with list of apps
    # $2 has variable name to set with list of apps
    #
    local lapps="" newapp fn
    if [ "${1:0:1}" == "@" ]
    then
	fn="${1:1:999}"
	while read line
	do
	    #
	    # Strip trailing spaces, tabs, and comments
	    #
            newapp="${line%%\#*}"    # Del EOL comments
            newapp="${newapp%"${newapp##*[^[:blank:]]}"}"  # Del trailing spaces/tabs
	    [ "$newapp" != "" ] && lapps="$lapps $newapp"
	done < $fn
    else
	lapps="$1"
    fi
    lapps="${lapps## }"      # Del leading spaces
    echo "$lapps"
}

function readl10n() {
    #
    # Get the L10N config from the running system
    # Sets: locale, timezone, wificountry, keymap
    #
    local tz=$(realpath /etc/localtime)
    # Keyboard
    source /etc/default/keyboard
    keymap="$XKBLAYOUT"
    # Locale
    source /etc/default/locale
    locale="$LANG"
    # Timezone
    timezone=${tz##/usr/share/zoneinfo/}
    # WiFi Country
    [ -f /etc/wpa_supplicant/wpa_supplicant.conf ] && IFS="=" read a wificountry <<<$(grep 'country=' /etc/wpa_supplicant/wpa_supplicant.conf)
    [ "$wificountry" == "" -a -f /etc/wpa_supplicant/wpa_supplicant-wlan0.conf ] && IFS="=" read a wificountry <<<$(grep 'country=' /etc/wpa_supplicant/wpa_supplicant-wlan0.conf)
}

function setbootset() {
    #
    # Handle --bootset, --svcdisable and --svcenable for customize and burn commands
    #
    local citems=() c key value
    if [ "$bootsetpairs" != "" ]
    then
	readarray -d, citems <<< $bootsetpairs
	for c in ${citems[@]}
	do
	    IFS=":=" read key value <<< $c
	    value="${value%,}"
	    ! [[ "$vbootset" =~ "|$key|" ]] && errexit "? Unrecognized --bootset key '$key'"
	    # Remove any old entry for this key and write the new one
	    sed -i "/^$key=/d" /mnt/sdm/etc/sdm/auto-1piboot.conf
	    echo "$key=$value" >> /mnt/sdm/etc/sdm/auto-1piboot.conf
	done
    fi
    if [ "$svcdisable" != "" ]
    then
	readarray -d, citems <<< $svcdisable
	for c in ${citems[@]}
	do
	    sed -i "/^service-enable=${c%,}/d" /mnt/sdm/etc/sdm/auto-1piboot.conf
	    echo "service-disable=${c%,}" >> /mnt/sdm/etc/sdm/auto-1piboot.conf
	done
    fi
    if [ "$svcenable" != "" ]
    then
	readarray -d, citems <<< $svcenable
	for c in ${citems[@]}
	do
	    sed -i "/^service-disable=${c%,}/d" /mnt/sdm/etc/sdm/auto-1piboot.conf
	    echo "service-enable=${c%,}" >> /mnt/sdm/etc/sdm/auto-1piboot.conf
	done
    fi

}

function checkfilelist() {
    #
    # $1 has list of "|"-separated files
    # $2 has name of switch (--switchname)
    local sifs="$IFS" citems=() fl
    IFS=""
    readarray -d\| citems <<< "$1"
    for fl in ${citems[@]}
    do
	fl="${fl%|}"
	fl="${fl/$'\n'}"
	[ ! -f $fl ] && errexit "? $2 file '$fl' not found"
    done
    IFS="$sifs"
}

function writeconfig() {
    #
    # Write config parameters into the image
    #
    [ -f $paramfile ] && rm -f $paramfile
    cat > $paramfile <<EOF
#Arguments passed from sdm into the IMG on $(date +'%Y-%m-%d %H:%M:%S')
version:$version
apps:"$apps"
xapps:"$xapps"
appfile:$appfile
xappfile:$xappfile
apip:$apip
apssid:$apssid
aptcache:$aptcache
aptconfirm:$aptconfirm
batch:$fbatch
bootadd:$bootadd
bootconfig:$bootconfig
bootscripts:$bootscripts
crond:$crond
cronhourly:$cronhourly
crondaily:$crondaily
cronweekly:$cronweekly
cronmonthly:$cronmonthly
cronsystemd:$cronsystemd
cscript:$cscript
csrc:$csrc
datefmt:$datefmt
dhcpcd:$dhcpcd
dhcpcdwait:$dhcpcdwait
dimg:$dimg
dimgdev:$dimgdev
domain:$domain
dtoverlay:$dtoverlay
dtparam:$dtparam
ecolors:$ecolors
eeprom:$eeprom
exports:$exports
fdirtree:$fdirtree
fstab:$fstab
hdmiforcehotplug:$hdmiforcehotplug
hdmigroup:$hdmigroup
hdmimode:$hdmimode
hostname:$hostname
keymap:$keymap
loadlocal:$loadlocal
locale:$locale
modprobe:$modprobe
motd:$motd
groups:$groups
myuid:$myuid
myuser:$myuser
pi1bootconf:$pi1bootconf
poptions:$poptions
rclocal:$rclocal
reboot:$reboot
noreboot:$noreboot
rebootwait:$rebootwait
rootpwd:$rootpwd
showapt:$showapt
showpwd:$showpwd
src:$src
ssh:$ssh
sysctl:$sysctl
timezone:$timezone
udev:$udev
vnc:$vnc
vncbase:$vncbase
wificountry:$wificountry
wpaconf:$wpaconf
fnowpa:$fnowpa
custom1:$custom1
custom2:$custom2
custom3:$custom3
custom4:$custom4
thishost:$thishost
EOF
}

function printhelp() {
    echo $"sdm $version
Usage:
 sudo /usr/local/sdm/sdm --customize [switches] sd-image-file
   Customize an SD Card image or SSD/SD Card
 sudo $0 --explore sd-image-file
   Explore an SD Card image or SSD/SD Card
 sudo $0 --mount sd-image-file
   Mount an SD Card image or SSD/SD Card
 sudo $0 --burn /dev/sdx --host target-hostname IMG-file
   Burn the SD Card image to the burn device
 sudo $0 --aptmaint aptfunction sd-image-file
   Do APT maintenance (update, upgrade) on an SD Card image or SSD/SD Card

Commands
 --burn devname      Copy the image to the storage device
 --burnfile filename Create a ready-to-burn customized Image file
 --customize         Customize the specified Image file
 --explore           Explore (nspawn shell) into image
 --info what         Display list of Locales, Keymaps, WiFi Countries, or Timezones
 --mount             Mount IMG file partitions and drop into interactive bash shell
Command Switches for --customize and --burn or as noted
 --1piboot conf-file Use alternate 1piboot.conf
 --apps applist      List of app packages to install or @file with list
 --xapps applist     List of X11 packages to install or @file with list
 --apip IPADDR       IP Address for WiFi Captive Portal [10.1.1.1]
 --apssid ssidname   SSID name for WiFi Captive Portal [sdm]
 --aptcache IPADDR   Use apt-cacher-ng with server 'IPADDR'
 --aptconfirm        Enable confirmation before apt commands
 --aptmaint options  Do apt commands batch-mode in the image (update, upgrade, autoremove)
 --batch             Perform customize operation and exit
 --bootadd key:value,key:value,... Add new keys and values to /boot/config.txt
 --bootconfig key:value,key:value,... Update and uncomment items in /boot/config.txt
 --bootset key:value,key:value,.. Set boot-time device settings (see README)
 --bootscripts       Run the scripts /usr/local/sdm/1piboot/0*-*.sh during first boot
 --cron-d file       Copy provided cron file to /etc/cron.d (can be used multiple times)
 --cron-daily file   Copy provided cron file to /etc/cron.daily (can be used multiple times)
 --cron-hourly file  Copy provided cron file to /etc/cron.hourly (can be used multiple times)
 --cron-monthly file Copy provided cron file to /etc/cron.monthly (can be used multiple times)
 --cron-weekly file  Copy provided cron file to /etc/cron.weekly (can be used multiple times)
 --cron-systemd      Disable cron service and enable systemd-based timers
 --cscript script    Custom Phase Configuration script
 --csrc dir          Source directory passed for Custom Phase scripts
 --custom[1-4] str   Can be used in Custom cscripts
 --datefmt str       Date format for logs [%Y-%m-%d %H:%M:%S]
 --ddsw str          Switches for dd command [bs=16M oflag=direct]
 --directory         sd-image-file is a directory tree rather than an IMG
 --dhcpcd file       Append file to /etc/dhcpcd.conf
 --dhcpcdwait        Enable dhcpcd Wait for Internet
 --domain name       Domain name (for use in Custom Phase Script; sdm does not use)
 --dtoverlay         Add dtoverlay=string setting to /boot/config.txt (can be used multiple times)
 --dtparam           Add dtparam=string setting to /boot/config.txt (can be used multiple times)
 --ecolors fg:bg:cur Set fg/bg/cursor colors when operating in the mounted IMG
 --eeprom str        Set the Pi eeprom directory
 --exports file      Copy named file to /etc/exports
 --extend            Extend the image by --xmb N MB [Default: 2048/2GB]
 --fstab file        Append file to /etc/fstab
 --groups list,of,groups Use this list of groups for user created with --user
                     [dialout,cdrom,floppy,audio,video,plugdev,users,adm,sudo,users,input,netdev,spi,i2c,gpio]
 --hdmi-force-hotplug Set hdmi_force_hotplug=1 in /boot/config.txt
 --hdmigroup n       Set /boot/config.txt hdmigroup value
 --hdmimode n        Set /boot/config.txt hdmimode value
 --host hostname     Hostname to write onto the storage device with --burn
 --keymap keymapname Set Keymap
 --L10n              Set Keymap, Locale, Timezone, and WiFi Country from running system
 --loadlocal args    Load WiFi Credentials from USB stick during first boot (see README)
 --locale localename Set the Locale
 --mcolors fg:bg:cur Set fg/bg/cursor colors when operating in --mount
 --modprobe file     Copy provided file to /etc/modprobe.d (can be used multiple times)
 --motd file         Use provided file as /etc/motd
 --nspawnsw str      Additional switches for nspawn command
 --poptions str      Set Phase 1 auto-run options
 --norestart         Do not restart after first boot (use on --burn command)
 --rclocal string    Add string as a command in /etc/rc.local (can be used multiple times)
 --reboot n          Restart the first boot of the system after n seconds
 --restart           Restart the first boot of the system after 20 seconds
 --rootpwd           Set a root password into the image
 --showapt           Display apt output as well as logging it
 --showpwd           Log password in /etc/sdm/history
 --ssh none|socket   No ssh or ssh sockets [Default: ssh service]
 --svcdisable svc1,svc2,... Disable the named services
 --svcenable  svc1,svc2,... Enable  the named services
 --sysctl file       Copy the named file to /etc/sysctl.d (can be used multiple times)
 --timezone tzname   Set the Timezone
 --udev file         Copy provided udev rules file to /etc/udev/rules.d (can be used multiple times)
 --uid uid           UID for non-root user [next free]
 --user username     Create non-root user
 --vnc name,res1,res2,...,resx Enable tight or tiger VNC server with specified resolutions
 --wifi-country country Set WiFi Country for unblocking WiFi
 --wpa wpaconf       wpa_supplicant.conf file to use
 --nowpa             Do not do WPA config file processing
 --xmb n             Set the --extend size in MB [2048]
 --version           Print sdm version number"
}

#
# Initialize and Parse the command
#
#
version="V4.05"
sdmcommandline="$0 $@"      #Used in error messages
apip="10.1.1.1"             #Default IP for the WiFi Captive Portal
apssid="sdm"                #Default SSID for the WiFi Captive Portal
apps=""                     #List of apps to install in sdm-base-installs
aptcache=""                 #IP address of apt-cacher-ng server
aptconfirm=0                #1=Pause before apt commands in sdm-apt-install and sdm-X-install
aptmaint=""                 #--aptmaint switch values
aptfunction=0               #1=Some apt batch function specified
bootadd=""                  #Items to add to /boot/config.txt
bootconfig=""               #/boot/config.txt items to set
bootscripts=0               #Run FirstBoot custom boot scripts
bootsetpairs=""             #Keys and values from --bootet
burn=0                      #1=Burn the image to the SD card
burndev=""                  #SD card device name for --burn
burnfile=0                  #1=Burn image to a file
burnfilefile=""             #Filename for --burnfile
crond=""                    #List of cron files to copy to /etc/cron.{d,hourly,daily,weekly,monthly}
cronhourly=""
crondaily=""
cronweekly=""
cronmonthly=""
cronsystemd=0               #1=disable cron service and enable systemd cron timers
csrc=""                     #Source directory for use by Custom Phase script
cscript=""                  #Custom Phase script
datefmt="%Y-%m-%d %H:%M:%S" #Default date format for history log
ddsw="bs=16M oflag=direct"  #Switches for dd
dhcpcd=""                   #Append this custom dhcpcd.conf to /etc/dhcpcd.conf
dhcpcdwait=0                #1=Enable wait for internet (like raspi-config System Options 'wait for network connection')
domain=""                   #--domain name
dtoverlay=""                #Collected --dtoverlay settings
dtparam=""                  #Collected --dtparam settings
ecolors="blue:gray:red"     #fg:bg:cursor
eeprom=""                   #If set, edit /etc/default/rpi-eeprom-update
exports=""                  #If set, copy file to /etc/exports
fcustomize=0                #True if customizing an image (either --customize or lack of burn,mount,explore)
fbatch=0                    #1=nspawn "batch" mode (non-interactive). Do Phase1 and exit
fdirtree=0                  #1=source is a directory tree, not an IMG or device
fdomount=0                  #1=Do a mount and drop into bash
fexplore=0                  #1=Just fire up nspawn to explore the system
fextend=0                   #1=extend image by --xmb MB
fextendonly=0               #1=Just extend and exit (this if no other command specified)
fnowpa=0                    #1=I really man no automatic no wpa config
fstab=""                    #Append this custom fstab to /etc/fstab
groups="dialout,cdrom,floppy,audio,video,plugdev,users,adm,sudo,users,input,netdev,spi,i2c,gpio" #Add created users to these groups
hdmiforcehotplug=0          #1=Enable hdmi_force_hotplug in /boot/config.txt
hdmigroup=""                #If set, edit /boot/config.txt and set
hdmimode=""                 #If set, edit /boot/config.txt and set
hname=""                    #Host name when using --burn
hostname=""                 #Written to cparams during --burn
imgext=2048                 #Number of MB to extend IMG (2048MB = 2GB)
keymap=""                   #Keyboard configuration
infocmd=0                   #1=--info command
loadl10n=0                  #1=Load Localization settings from running system 
loadlocal=""                #Non-null specifies loading wifi creds on firstboot (currently USB only)
locale=""                   #Locale
modprobe=""                 #List of files to copy to /etc/modprobe.d
motd=""                     #File to place as /etc/motd
myuser=""                   #Non-root user to create. Default is no non-root user created
myuid=""                    #UID for non-root user if created
noreboot=0                  #1=Do not restart system after first boot
nspawnsw=""                 #Switches for nspawn
poptions=""                 #Phase options
pvers=0                     #Print version number
rclocal=""                  #Command(s) to add to /etc/rc.local
reboot=0                    #1=Reboot from First Boot
rebootwait=20               #Number of seconds to wait after systemd thinks system is fully booted to reboot
drebootwait=$rebootwait     # Used to see if rebootwait should be modified on burn
showpwd=0                   #1=Log password into /etc/sdm/history
ssh=""                      #--ssh none (no ssh) or --ssh socket (ssh via sockets)
                            #  Default is to write /boot/ssh
sysctl=""                   #Copy named file to /etc/sysctl.d
timezone=""                 #Timezone setting
udev=""                     #Copy named udev files to /etc/udev/rules.d
wificountry=""              #WiFi country setting
vaptmaintops="|update|upgrade|autoremove|" #Options for --apt
vpoptions="|apps|nofirstboot|noupdate|noupgrade|noautoremove|nodmconsole|novnc|samba|xwindows|xapps|none|" #Valid --poptions
vbootset="|boot_splash|boot_wait|camera|i2c|net_names|onewire|rgpio|serial|spi|blanking|overscan|pixdub|audio|pi4video|boot_behaviour|overclock|boot_order|powerled|"
vloadopts="|usb|wifi|flashled|internet|"  #Valid options for --loadlocal
vnc=""                      #--vnc arguments
vncbase="5900"              # Base port for VNC socket services
rootpwd=0                   #1=Set root password as well
showapt=0                   #1=Display apt output on terminal as well as logging
xapps=""                    #List of X apps to install in sdm-X-installs
pi1bootconf=""              #Command-line specified 1piboot.conf file to use
wpaconf=""                  #Command-line specified wpa_supplicant.conf
custom1=""                  #For custom use
custom2=""                  #For custom use
custom3=""                  #For custom use
custom4=""                  #For custom use
#
# custom.ized is created in the image so that the Phase 0 customization only done once automatically
#
sdmdone="/mnt/sdm/etc/sdm/custom.ized"
paramfile="/mnt/sdm/etc/sdm/cparams"

[[ ! $EUID -eq 0 ]] && errexit "? Please run as root: sudo $0 $*"
[ "$(which systemd-nspawn)" == "" ] && echo "? Cannot find systemd-nspawn" && errexit "? Please 'sudo apt install systemd-container' first"
#
# Parse the command line
#
cmdline="$0 $*"
longopts="help,1piboot:,apps:,aptcache:,aptconfirm,aptmaint:,apip:,apssid:,\
batch,bootadd:,bootconfig:,bootscripts,bootset:,burn:,burnfile:,\
cron-d:,cron-daily:,cron-hourly:,cron-monthly:,cron-weekly:,cron-systemd,\
cscript:,csrc:,customize,datefmt:,ddsw:,dhcpcd:,dhcpcdwait,directory,\
domain:,dtoverlay:,dtparam:,ecolors:,eeprom:,explore,exports:,extend,\
fstab:,groups:,hdmi-force-hotplug,hdmigroup:,hdmimode:,host:,hostname:,\
info,keymap:,l10n,loadlocal:,locale:,\
mcolors:,modprobe:,motd:,mount,norestart,noreboot,nspawnsw:,\
poptions:,rclocal:,reboot:,restart,\
rootpwd,showapt,showpwd,ssh:,svcdisable:,svcenable:,sysctl:,timezone:,udev:,uid:,user:,\
vnc:,vncbase:,wifi-country:,wificountry:,xapps:,xmb:,\
custom1:,custom2:,custom3:,custom4:,version,nowpa,wpa:"

OARGS=$(getopt -o h --longoptions $longopts -n 'sdm' -- "$@")
[ $? -ne 0 ] && errexit "? $0: Unable to parse command"
eval set -- "$OARGS"

while true
do
    case "${1,,}" in
	# 'shift 2' if switch has argument, else just 'shift'
	--1piboot)     pi1bootconf=$2; shift 2 ;;
	--apip)        apip=$2       ; shift 2 ;;
	--apssid)      apssid=$2     ; shift 2 ;;
	--apps)        apps="$2"     ; shift 2 ;;
	--aptcache)    aptcache=$2   ; shift 2 ;;
	--aptconfirm)  aptconfirm=1  ; shift ;;
	--aptmaint)    aptmaint="${2,,}"; shift 2 ;;
	--batch)       fbatch=1      ; shift 1 ;;
	--bootadd)     bootadd=$2    ; shift 2 ;;
	--bootconfig)  bootconfig=$2 ; shift 2 ;;
	--bootscripts) bootscripts=1 ; shift 1 ;;
	--bootset)     bootsetpairs=$2 ; shift 2 ;;
	--burn)        burn=1 ;
		       burndev=$2    ; shift 2 ;;
	--burnfile)    burnfile=1 ;
		       burnfilefile=$2 ; shift 2 ;;
	--cron-d)      [ "$crond" == "" ] && crond="$2" || crond="$crond|$2" ; shift 2 ;;
	--cron-hourly) [ "$cronhourly" == "" ] && cronhourly="$2" || cronhourly="$cronhourly|$2" ; shift 2 ;;
	--cron-daily)  [ "$crondaily" == "" ] && crondaily="$2" || crondaily="$crondaily|$2" ; shift 2 ;;
	--cron-weekly) [ "$cronweekly" == "" ] && cronweekly="$2" || cronweekly="$cronweekly|$2" ; shift 2 ;;
	--cron-monthly) [ "$cronmonthly" == "" ] && cronmonthly="$2" || cronmonthly="$cronmonthly|$2" ; shift 2 ;;
	--cron-systemd) cronsystemd=1 ; shift 1 ;;
	--cscript)     cscript=$2    ; shift 2 ;;
	--csrc)        csrc=$2       ; shift 2 ;;
	--customize)   fcustomize=1  ; shift 1 ;;
	--datefmt)     datefmt=$2    ; shift 2 ;;
	--ddsw)        ddsw=$2       ; shift 2 ;;
	--dhcpcd)      dhcpcd=$2     ; shift 2 ;;
	--dhcpcdwait)  dhcpcdwait=1  ; shift 1 ;;
        --directory)   fdirtree=1    ; shift 1 ;;
	--domain)      domain=$2     ; shift 2 ;;
	--dtoverlay)   [ "$dtoverlay" == "" ] && dtoverlay="$2" || dtoverlay="$dtoverlay|$2" ; shift 2 ;;
	--dtparam)     [ "$dtparam" == "" ]   && dtparam="$2"   || dtparam="$dtparam|$2" ; shift 2 ;;
	--ecolors)     ecolors=$2    ; shift 2 ;;
	--eeprom)      eeprom=$2     ; shift 2 ;;
	--explore)     fexplore=1    ; shift 1 ;;
	--exports)     exports=$2    ; shift 2 ;;
	--extend)      fextend=1     ; shift 1 ;;
	--fstab)       fstab=$2      ; shift 2 ;;
	--groups)      groups=$2     ; shift 2 ;;
	--hdmi-force-hotplug) hdmiforcehotplug=1 ; shift 1 ;;
	--hdmigroup)   hdmigroup=$2  ; shift 2 ;;
	--hdmimode)    hdmimode=$2   ; shift 2 ;;
	--hostname|--host) hname=$2  ; shift 2 ;;
	--keymap)      keymap=$2     ; shift 2 ;;
	--l10n)        loadl10n=1    ; shift 1 ;;
	--info)        infocmd=1     ; shift 1 ;;
	--loadlocal)   loadlocal="${2,,}" ; shift 2 ;;
	--locale)      locale=$2     ; shift 2 ;;
	--mcolors)     mcolors=$2    ; shift 2 ;;
	--modprobe)    [ "$modprobe" == "" ] && modprobe="$2" || modprobe="$modprobe|$2" ; shift 2 ;;
	--motd)        motd=$2       ; shift 2 ;;
	--mount)       fdomount=1    ; shift 1 ;;
	--norestart|--noreboot) noreboot=1 ; shift 1 ;;
	--nowpa)       fnowpa=1      ; shift 1 ;;
	--nspawnsw)    nspawnsw=$2   ; shift 2 ;;
	--poptions)    poptions="${2,,}" ; shift 2 ;;
	--rclocal)     [ "$rclocal" == "" ] && rclocal="$2" || rclocal="${rclocal}|$2" ; shift 2 ;;
	--reboot)      rebootwait=$2 ;
		       reboot=1      ; shift 2 ;;
	--restart)      reboot=1     ; shift 1 ;;
	--rootpwd)     rootpwd=1     ; shift 1 ;;
	--showapt)     showapt=1     ; shift 1 ;;
	--showpwd)     showpwd=1     ; shift 1 ;;
	--ssh)         ssh=$2        ; shift 2 ;;
	--svcdisable)  svcdisable=$2 ; shift 2 ;;
	--svcenable)   svcenable=$2  ; shift 2 ;;
	--sysctl)      [ "$sysctl" == "" ] && sysctl="$2" || sysctl="$sysctl|$2" ; shift 2 ;;
	--timezone)    timezone=$2   ; shift 2 ;;
	--udev)        [ "$udev" == "" ] && udev="$2" || udev="$udev|$2" ; shift 2 ;;
	--uid)         myuid=$2      ; shift 2 ;;
	--user)        myuser=$2     ; shift 2 ;;
	--vnc)         vnc="$2"      ; shift 2 ;;
	--vncbase)     vncbase="$2"  ; shift 2 ;;
	--wifi-country|--wificountry) wificountry=${2^^} ; shift 2 ;;
	--wpa)         wpaconf=$2    ; shift 2 ;;
	--xapps)       xapps="$2"    ; shift 2 ;;
	--xmb)         imgext=$2     ; shift 2 ;;
	--custom1)     custom1=$2    ; shift 2 ;;
	--custom2)     custom2=$2    ; shift 2 ;;
	--custom3)     custom3=$2    ; shift 2 ;;
	--custom4)     custom4=$2    ; shift 2 ;;
	--version)     pvers=1       ; shift 1 ;;
	--)            shift ; break ;;
	-h|--help)     printhelp ; shift ; exit ;;
	*) errexit "? $0: Internal error" ;;
    esac
done

dimg="$1"
[ "${dimg,,}" == "help" ] && printhelp && exit
src=$(dirname $0)
[ $pvers -eq 1 ] && echo "sdm $version" && exit 0
source /usr/local/sdm/sdm-cparse           # Get function defs

#
# Adjust settings based on switches and check for conflicting switches
# and erroneous switch values
#

if [ "$cscript" != "" ]
then
    if [ ! -x "$cscript" ]
    then
	fn="$src/$(basename $cscript)"
	if [ -x "$fn" ]
	then
	    cscript=$fn
	fi
    fi
fi
#
# Handle --info switch right now. $dimg has the requested info item (timezones, locales, keymaps, wifi-countries)
#
if [ $infocmd -eq 1 ]
then
    case "${dimg,,}" in
	time*)
	    less /usr/share/zoneinfo/zone1970.tab ;;
	local*)
	    less /usr/share/i18n/SUPPORTED ;;
	key*)
	    less /usr/share/doc/keyboard-configuration/xorg.lst ;;
	wifi*)
	    less /usr/share/zoneinfo/iso3166.tab ;;
	help|*)
	    [ "${dimg,,}" != "help" ] && echo "? Unrecognized --info option '$dimg'" ;
	    echo "" ;
	    echo "The --info command accepts one of four switch values:" ;
	    echo "timezone:     Show --timezone values";
	    echo "locale:       Show --locale values" ;
	    echo "keymap:       Show --keymap values" ;
	    echo "wifi-country: Show --wifi-country values" ;
	    echo "" ;
	    echo "Keys can be abbreviated to 'time', 'local', 'key', and 'wifi'" ;
	    ;;
	*)
    esac
exit 0
fi

cscript="$(fndotfullpath $cscript)"
[ $burn -eq 1 -a $burnfile -eq 1 ] && errexit "? Switch conflict: --burn and --burnfile"
[ $burn -eq 1 -o $burnfile -eq 1 ] && burning=1 || burning=0
[ $burning -eq 1 -a $fdomount -eq 1 ] && errexit "? Switch conflict: --burn|--burnfile and --mount"
[ $burning -eq 1 -a $fexplore -eq 1 ] && errexit "? Switch conflict: --burn|--burnfile and --explore"
[ $fdomount -eq 1 -a $fexplore -eq 1 ] && errexit "? Switch conflict: --mount and --explore"
[ $reboot -eq 1 -a $noreboot -eq 1 ] && errexit "? Switch conflict: --restart and --norestart"
[ $fcustomize -eq 1 -a $burning -eq 1 ] && errexit "? Switch conflict: --customize and --burn|--burnfile"
[ $fcustomize -eq 1 -a $fdomount -eq 1 ] && errexit "? Switch conflict: --customize and --mount"
[ $fcustomize -eq 1 -a $fexplore -eq 1 ] && errexit "? Switch conflict: --customize and --explore"
[ $burning -eq 1 -a $fdirtree -eq 1 ] && errexit "? Switch conflict: --directory and --burn|--burnfile"
if [ "$aptmaint" != "" ]
then
    [ $(($burning+$fcustomize+$fexplore+$fdomount)) -gt 0 ] && errexit "? One or more switches conflict with --aptmaint"
    aptfunction=1
fi
#
# Ensure action requested: burn, mount, explore, aptmaint, customize
#
if [ $(($aptfunction+$burning+$fcustomize+$fexplore+$fdomount)) -eq 0 ]
then
    # Handle --extend only 
    [ $fextend -eq 0 ] && errexit "? No command specified (--aptmaint --burn, --customize, --explore, --mount)"
    fextendonly=1
fi
[ $fdirtree -eq 1 ] && fextend=0 && fextendonly=0
[ "$src" != "" -a ! -d "$src" ] && errexit "? Source directory '$src' not found"
[ "$csrc" != "" -a ! -d "$csrc" ] && errexit "? Custom source directory '$csrc' not found"
[ "$cscript" != "" -a ! -f "$cscript" ] && errexit "? Custom Phase Script '$cscript' not found"
[ "$cscript" != "" -a ! -x "$cscript" ]  && errexit "? Custom Phase Script '$cscript' not executable"
p1bootconf="$(fndotfullpath $p1bootconf)"
[ "$pi1bootconf" != "" -a ! -f "$pi1bootconf" ] && errexit "? Custom 1piboot.conf file '$pi1bootconf' not found"
if [ "$ssh" != "" ]
then
    [[ ! "|none|socket|" =~ "|$ssh|" ]] && errexit "? Unknown value '$ssh' for --ssh"
fi
[ "$rebootwait" != "" ] && checknumeric "$rebootwait" "--reboot"
[ "$hdmigroup" != "" ] && checknumeric "$hdmigroup" "--hdmigroup"
[ "$hdmimode" != "" ] && checknumeric "$hdmimode" "--hdmimode"
[ "$myuid" != "" ] && checknumeric "$myuid" "--uid"
[ "$imgext" != "" ] && checknumeric "$imgext" "--xmb"
[ "$hdmimode" != "" -a "$hdmigroup" == "" ] && errexit "? --hdmimode set but not --hdmigroup"
[ "$hdmigroup" != "" -a "$hdmimode" == "" ] && errexit "? --hdmigroup set but not --hdmimode"
! cktimezone $timezone && errexit "? Unknown Timezone '$timezone'"
! ckwificountry $wificountry && errexit "? Unknown WiFi Country '$wificountry'"
! cklocale $locale && errexit "? Unknown Locale '$locale'"
! ckkeymap $keymap && errexit "? Unknown Keymap '$keymap'"

poptions=$(poptcheck "$poptions" "$vpoptions" "--poption")
exitiferr "$poptions"
loadlocal=$(poptcheck "$loadlocal" "$vloadopts" "--loadlocal")
exitiferr "$loadlocal"
aptmaint=$(poptcheck "$aptmaint" "$vaptmaintops" "--aptmaint")
exitiferr "$aptmaint"
#
# Check sanity of the disk image argument
#
[ "$dimg" == "" ] && errexit "? No disk image specified"
dimgdev=0
if [ $fdirtree -eq 1 ]
then
    [ ! -d $dimg ] && errexit "? Cannot find directory '$dimg'"
elif [ ! -f "$dimg" ]
then
    [ ! -b $dimg ] && errexit "? Disk image file or device '$dimg' does not exist"
    dimgdev=1
fi    
#
# Ensure wpa is correctly configured for the request, if needed
#
[ "$wpaconf" != "" -a ! -f "$wpaconf" ] && errexit "? wpa_supplicant config file '$wpaconf' not found"
[ $fcustomize -eq 1 -a "$wpaconf" == "" -a $fnowpa -ne 1 ] && errexit "? Use --nowpa for no automatic wpa processing or --wpa to specify your wpa_supplicant.conf"

if [ "$eeprom" != "" ]
then
    if [[ ! "|critical|stable|beta|" =~ "|$eeprom|" ]]
    then
	echo "% --eeprom value '$eeprom' is not one of the standard 'critical/stable/beta'. Continuing..."
    fi
fi    

[ "$dhcpcd" != ""  -a ! -f "$dhcpcd" ]  && errexit "? --dhcpcd file '$dhcpcd' not found"
[ "$exports" != "" -a ! -f "$exports" ] && errexit "? --exports file '$exports' not found"

for c in d hourly daily weekly monthly
do
    ct="cron$c"
    cf=${!ct}     #  (eval "cf=\$$ct" alternate way)
    [ "$cf" != "" ] && checkfilelist "$cf" "--cron-$c"
done

[ "$sysctl" != ""  ] && checkfilelist "$sysctl" "--sysctl"
[ "$modprobe" != "" ] && checkfilelist "$modprobe" "--modprobe"
[ "$motd" != "" -a "$motd" != "/dev/null" ] && checkfilelist "$motd" "--motd"
[ "$udev" != "" ] && checkfilelist "$udev" "--udev"
if [ "$vnc" != "" ]
then
    ! [[ "$vnc" =~ "tiger" ]] && ! [[ "$vnc" =~ "tight" ]] && errexit "? --vnc argument must contain 'tiger' or 'tight'"
fi
#
# parse and set ecolors
#
[ "$ecolors" == "" ] && ecolors="blue:gray:red"
IFS=":" read efg ebg ecursor <<< $ecolors
[ "$efg" == "" ] && efg="blue"
[ "$ebg" == "" ] && ebg="gray"
[ "$ecursor" == "" ] && ecursor="red"
ecolors="$efg:$ebg:$ecursor"

#
# Process --apps and --xapps switches
#
appfile=$(findappfile "$apps") #Gets real @file nam or list of apps into '$appfile'
exitiferr "$appfile"
apps=$(getapplist "$appfile")    #Gets definitive app list into '$apps'
xappfile=$(findappfile "$xapps") #Ditto for xappfile and xapps
exitiferr "$xappfile"
xapps=$(getapplist "$xappfile")
#
# Process the command. Actions are burn, custommize, mount, and standalone --extend
#
thishost="$(hostname)"
#
# Process --burn command
#
if [ $burning -eq 1 ]
then
    [ ! -d /mnt/sdm ] && mkdir /mnt/sdm
    if [ $burn -eq 1 ]
    then
	#
	# Burning to a device
	#
	[ "$burndev" == "" ] && errexit "? No storage device specified"
	ismounted $burndev && errexit "? Device '$burndev' is mounted"
	[ ! -b $burndev ] && errexit "? '$burndev' is not a block device"
	[ "$hname" == "" ] && echo "% hostname not specified with --host; hostname will not be written to $burndev"
	# Stash burn messages in an array until log on SD Card is mounted and available 
	declare -a burnmsg
	burnmsg+=("$(thisdate) * Burn '$dimg' to SD Card '$burndev'")
	burnmsg+=("$(thisdate) > Burn command line: $cmdline")
	echo "* Burn '$dimg' to '$burndev'..."
	ddcmd="dd if=$dimg of=$burndev status=progress $ddsw"
	burnmsg+=("$(thisdate) > dd command: $ddcmd")
	echo "$ddcmd"
	$ddcmd
	[ $? -ne 0 ] && errexit "? dd error"
	burnmsg+=("$(thisdate) > dd Copy completed")
	# Prevent mount errors
	sync ; sync
	sleep 1
	[[ "$burndev" =~ "mmcblk" ]] && p2="p2" || p2="2"
	mount -v ${burndev}${p2} /mnt/sdm
	! ismounted ${burndev}${p2} && errexit "? Unable to mount ${burndev}${p2}"
    else
	#
	# Burning to a file
	#
	[ "$burnfilefile" == "" ] && errexit "? No Output Image file specified"
	[ -f $burnfilefile ] && errexit "? Output Image file '$burnfilefile' exists"
	[ "$hname" == "" ] && echo "% hostname not specified with --host; hostname will not be written the Output Image"
	# Stash burn messages in an array until log on SD Card is mounted and available 
	declare -a burnmsg
	burnmsg+=("$(thisdate) * Burn '$dimg' to Output Image '$burnfilefile'")
	burnmsg+=("$(thisdate) > Burn Image command line: $cmdline")
	echo "* Burn '$dimg' to Output Image '$burnfilefile'..."
	ddcmd="dd if=$dimg of=$burnfilefile status=progress $ddsw"
	burnmsg+=("$(thisdate) > dd command: $ddcmd")
	echo "$ddcmd"
	$ddcmd
	[ $? -ne 0 ] && errexit "? Exiting due to dd error"
	burnmsg+=("$(thisdate) > Image copy completed")
	domount "$burnfilefile"
    fi
    #
    # Set hostname into the image
    #
    if [ "$hname" != "" -a -f /mnt/sdm/etc/hostname ]
    then
	[ $burn -eq 1 ] && burnmsg+=("$(thisdate) > Set hostname '$hname' onto the storage") || burnmsg+=("$(thisdate) > Set hostname '$hname' in Output Image")
	echo $hname > /mnt/sdm/etc/hostname
	sed -i "s/127.0.1.1.*raspberrypi/127.0.1.1\t$hname/g" /mnt/sdm/etc/hosts
    fi
    if [ -d /mnt/sdm/usr/local/sdm -a -d /mnt/sdm/etc/sdm ]
    then
	# Save settings made with the --burn command
	bapip=$apip
	bapssid=$apssid
	bdhcpcd=$dhcpcd
	bexports=$exports
	bsysctl=$sysctl
	breboot=$reboot
	bnoreboot=$noreboot
	brebootwait=$rebootwait
	bscript=$bootscripts
	bwificountry="$wificountry"
	blocale="$locale"
	bkeymap="$keymap"
	btimezone="$timezone"
	bwpaconf="$wpaconf"
	declare -x SDMPHASE0="PHASE0" # Force readparams to use /mnt/sdm
	readparams                    # Read settings from the SD card
	unset SDMPHASE0
        [ $breboot -eq 1 ] && reboot=$breboot
	[ $bnoreboot -eq 1 ] && reboot=0 && noreboot=1
        [ $bscript -eq 1 ] && bootscripts=$bscript  #If we weren't set to run scripts, use setting from IMG
	[ $brebootwait -ne $drebootwait ] && rebootwait=$brebootwait
	[ "$bapip" != "10.1.1.1" ] && apip=$bapip
	[ "$bapssid" != "sdm" ] && apssid=$bapssid
	[ "$bwificountry" != "" ] && wificountry="$bwificountry"
	if [[ "$loadllocal" =~ "|wifi|" ]]
	then
	    [ "$wificountry" == "" ] && echo "% No --wifi-country specified with --loadlocal wifi; Using 'US' for a short time" && wificountry="US"
	fi
	[ "$bkeymap" != "" ] && echo "keymap=$bkeymap" >> /mnt/sdm/etc/sdm/auto-1piboot.conf
	[ "$btimezone" != "" ] && echo "timezone=$btimezone" >> /mnt/sdm/etc/sdm/auto-1piboot.conf
	[ "$blocale" != "" ] && echo "locale=$blocale" >> /mnt/sdm/etc/sdm/auto-1piboot.conf
	if [ "$bdhcpcd" != "" ]
	then
	    cat $bdhcpcd >> /mnt/sdm/etc/dhcpcd.conf
	    burnmsg+=("$(thisdate) > Append '$bdhcpcd' to /etc/dhcpcd.conf")
	    echo "> Append '$bdhcpcd' to /etc/dhcpcd.conf"
	fi
	if [ "$bexports" != "" ]
	then
	    cp $bexports /mnt/sdm/etc/exports
	    burnmsg+=("$(thisdate) > Copy '$bexports' to /etc/exports")
	    echo "> Copy '$bexports' to /etc/exports"
	fi
	if [ "$bsysctl" != "" ]
	then
	    cp $bsysctl /mnt/sdm/etc/sysctl.d
	    burnmsg+=("$(thisdate) > Copy '$bsysctl' to /etc/sysctl.d/$(basename $bsysctl)")
	    echo "> Copy '$bsysctl' to /etc/sysctl.d/$(basename $bsysctl)"
	fi
	if [ "$bwpaconf" != "" ] # was --wpa specified on the burn command?
	then
	    [ ! -f $bwpaconf ] && echo "% --wpa config file '$bwpaconf' not found; Skipping"
	    if [ $burn -eq 1 ]
	    then
		burnmsg+=("$(thisdate) > Copy WPA Supplicant configuration '$bwpaconf' to '$burndev'")
		echo "> Copy WPA Supplicant configuration '$bwpaconf' to '$burndev'"
	    else
		burnmsg+=("$(thisdate) > Copy WPA Supplicant configuration '$bwpaconf' to Image '$burnfilefile'")
		echo "> Copy WPA Supplicant configuration '$bwpaconf' to '$burnfilefile'"
	    fi
	    [ -f $bwpaconf ] && cp $bwpaconf /mnt/sdm/etc/wpa_supplicant/wpa_supplicant.conf
	    wpaconf="$bwpaconf"   # Write updated wpaconf to SD Card params
	fi
	hostname="$hname"         # So it gets written to updated params on SD card
	setbootset    # Handle --bootset settings
  	writeconfig                  # Write updated params to the SD card
	[ $rebootwait -ne $drebootwait ] && wmsg=" with a $rebootwait second wait" || wmsg=""
	[ $bootscripts -eq 1 ] && burnmsg+=("$(thisdate) > First System Boot Custom Boot Scripts enabled${wmsg}") || \
		burnmsg+=("$(thisdate) > First System Boot Custom Boot Scripts disabled")
	[ $reboot -eq 1 ] && burnmsg+=("$(thisdate) > First System Boot automatic restart enabled") || \
		burnmsg+=("$(thisdate) > FirstBoot System Boot automatic restart disabled")
	[ $burn -eq 1 ] && burnmsg+=("$(thisdate) * Burn Completed") || burnmsg+=("$(thisdate) * Image Completed")
	[ $burn -eq 1 ] && echo "> Write burn log entry to storage '$burndev'" || echo "> Write burn log entry to Image '$burnfilefile'"
	for (( i=0 ; i < ${#burnmsg[@]} ; i++ ))
	do
	    echo "${burnmsg[$i]}" >> /mnt/sdm/etc/sdm/history
	done
	[ $bootscripts -eq 1 ] && echo "> First System Boot Custom Boot Scripts enabled" || echo "> First System Boot Custom Boot Scripts disabled"
	[ $reboot -eq 1 ] && echo "> First System Boot automatic restart enabled${wmsg}" || echo "> First System Boot automatic restart disabled"
    else
	echo "% IMG '$dimg' is not sdm-enhanced; Burn data will not be written"
    fi
    [ $burn -eq 1 ] && ismounted ${burndev}${p2} && umount -v ${burndev}${p2} || docleanup
    [ $burn -eq 1 ] && echo "* Storage '$burndev' is ready" || echo "* Storage Image '$burnfilefile' is ready"
    exit 0
fi
#
# Process --mount command
#
if [ $fdomount -eq 1 ]
then
    domount
    echo ""
    if [ $fdirtree -eq 1 ]
    then
	echo "Directory '$dimg' mounted on /mnt/sdm"
    else
	[ $dimgdev -eq 0 ] && echo "IMG '$dimg' mounted on /mnt/sdm" || echo "Device '$dimg' mounted on /mnt/sdm"
    fi
    echo "** BE VERY CAREFUL! **"
    echo "** Precede all path references by /mnt/sdm or you may modify the running system **"
    echo ""
    echo "Use 'exit' to Exit the Bash shell and unmount the IMG file"
    echo ""
    [ "$mcolors" == "" ] && mcolors="black:LightSalmon1:blue"
    IFS=":" read mfg mbg mcursor <<< $mcolors
    [ "$mfg" == "" ] && mfg="black"
    [ "$mbg" == "" ] && mbg="LightSalmon1"
    [ "$mcursor" == "" ] && mcursor="blue"

    stermcolors "$mfg" "$mbg" "$mcursor" xt
    cd /mnt/sdm
    bash < $(tty)
    cd - > /dev/null
    docleanup
    resetcolors xt
    exit 0
fi
#
# Extend the image if --extend
#
if [ $fextend -eq 1 ]
then
    echo "Extend disk image by ${imgext}MB..."
    extendimage "$dimg" "$imgext"
    #
    # Mount the image file into a loop device and resize the file system
    #
    domount
    echo " * (Ignore on-line resizing message) *"
    resize2fs ${loop}p2
fi
if [ $fextendonly -eq 1 ]
then
    # --extend (only). Cleanup and exit
    docleanup
    exit 0
else
    # Not --extend (only)
    [ ! -d /mnt/sdm/boot ] && domount
fi
#
# Handle commands --aptmaint, --customize, and --explore
#
icolors=0    # Don't set colors around systemd-nspawn
if [ $fcustomize -eq 0 ]
then
    if [ "$aptmaint" != "" ]
    then
	fbatch=1
	spawncmd="/usr/local/sdm/sdm-phase1 apt $aptmaint"
	if [ ! -f /mnt/sdm/usr/local/sdm/sdm-phase1 ]
	then
	    echo "? sdm has not customized image '$dimg'"
	    docleanup
	    exit 1
	fi
    else
	#
	# Doing --explore
	#
	[ $dimgdev -eq 0 ] && echo "* nspawn into image '$dimg'" || echo "* nspawn into device '$dimg'"
	spawncmd=""
	icolors=1
    fi
else
    #
    # Doing a customization
    # Create and populate /usr/local/sdm and /etc/sdm in the IMG
    #
    if [ -f $sdmdone ]
    then
	if ! askyn "** Image '$dimg' has already been customized. Redo?" "-n 1"
	then
	    echo ""
	    echo "** You can explore the image with '$0 --explore $dimg'"
	    docleanup
	    exit 0
	else
	    echo ""
	fi
    fi
    declare -x SDMPHASE0="PHASE0"
    pi1bootconf="$(fndotfullpath $pi1bootconf)"
    spawncmd="/usr/local/sdm/sdm-phase1"
    #
    # Create and populate /usr/local/sdm tree
    #
    [ ! -d /mnt/sdm/etc/sdm ] && mkdir /mnt/sdm/etc/sdm /mnt/sdm/etc/sdm/assets /mnt/sdm/etc/sdm/0piboot
    chmod 700 /mnt/sdm/etc/sdm
    echo "# sdm added these settings from the command line (see /etc/sdm/history)" > /mnt/sdm/etc/sdm/auto-1piboot.conf
    setbootset    # Handle --bootset settings
    [ ! -d /mnt/sdm/usr/local/sdm ] && mkdir /mnt/sdm/usr/local/sdm \
					     /mnt/sdm/usr/local/sdm/1piboot
    cp $src/{sdm,sdm-phase0,sdm-phase1,sdm-cparse} /mnt/sdm/usr/local/sdm
    cp $src/{sdm-apt,sdm-apt-cacher,sdm-firstboot} /mnt/sdm/usr/local/sdm
    cp $src/{sdm-cportal,sdm-logmsg} /mnt/sdm/usr/local/sdm
    chmod 755 /mnt/sdm/usr/local/sdm/*
    [ "${appfile:0:1}" == "@" ]  && cp -f ${appfile:1:999}  /mnt/sdm/usr/local/sdm
    [ "${xappfile:0:1}" == "@" ] && cp -f ${xappfile:1:999} /mnt/sdm/usr/local/sdm
    cp -f $src/1piboot/{010-disable-triggerhappy.sh,030-disable-rsyslog.sh} /mnt/sdm/usr/local/sdm/1piboot
    chmod 755 /mnt/sdm/usr/local/sdm/1piboot/*.sh
    logtoboth "* Start Configuration"
    logtoboth "> Command Line: $cmdline"
    logfreespace
    logtoboth "> Copy sdm to /usr/local/sdm in the IMG"   # Yes, already done above ;)
    if [ $loadl10n -eq 1 ]
    then
	readl10n
	logtoboth "> Load Localization (L10N) settings from running system"
	logtoboth "> * Keymap:       $keymap"
	logtoboth "> * Locale:       $locale"
	logtoboth "> * Timezone:     $timezone"
	logtoboth "> * WiFi Country: $wificountry"
    fi
    if [ "$pi1bootconf" != "" ]
    then
	logtoboth "> Copy Custom 1piboot.conf '$pi1bootconf' to the IMG"
	cp $pi1bootconf /mnt/sdm/etc/sdm/1piboot.conf
	cp $pi1bootconf /mnt/sdm/usr/local/sdm/1piboot                                         #Drop a copy in /usr/local/sdm in the IMG
    else
	cp $src/1piboot/1piboot.conf /mnt/sdm/etc/sdm/
    fi
    chmod 644 /mnt/sdm/etc/sdm/1piboot.conf
    if [ "$cscript" != "" ]
    then
	logtoboth "> Copy Custom Phase Script '$cscript' to /usr/local/sdm in the IMG"
	cp $cscript /mnt/sdm/usr/local/sdm
    fi
    chmod 755 /mnt/sdm/usr/local/sdm/*
    # If --apps and/or --xapps are files copy them also. If not, clear the variables for writeconfig
    [ "${appfile:0:1}" == "@" ]  && cp ${appfile:1:999}  /mnt/sdm/usr/local/sdm || appfile=""
    [ "${xappfile:0:1}" == "@" ] && cp ${xappfile:1:999} /mnt/sdm/usr/local/sdm || xappfile=""
    #
    # Write the config settings into the IMG
    #
    writeconfig
    #
    # Perform Phase 0 on the image
    #
    /mnt/sdm/usr/local/sdm/sdm-phase0
    unset SDMPHASE0
    touch $sdmdone
    
    echo "* nspawn into image '$dimg' for Phase 1"
    echo ""
fi

[ $icolors -eq 1 ] && stermcolors "$efg" "$ebg" "$ecursor" xt
systemd-nspawn --directory=/mnt/sdm $nspawnsw $spawncmd < $(tty)
docleanup
[ $icolors -eq 1 ] && resetcolors xt

exit 0
